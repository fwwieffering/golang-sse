# golang-sse
An implmementation of Server Sent Events in golang. Used https://thoughtbot.com/blog/writing-a-server-sent-events-server-in-go as a starting point to build up from

Created this as a learning exercise to understand the standard.

## Features
[Event stream format](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events#Event_stream_format)
- [x] send `data` field
- [x] send `id` field
- [ ] send `event` field
- [ ] send `retry` field

- [ ] replay events in topic to new subscribers
- [ ] process `Last-Event-ID` header

## Using
Instantiate a server object
```golang
import sse "github.com/fwwieffering/golang-sse"

func main() {
    s := sse.NewServer()
}
```

Create a handler using the `MakeHandler` function. Stream topic parameterization is customized by passing a function to `MakeHandler` that extracts the stream topic from the request

```golang
    // stream topic is gathered from query paramter ?stream= in this example
	handler := s.MakeHandler(func(r *http.Request) (string, error) {
		streamID := r.URL.Query().Get("stream")
		if streamID == "" {
			return "", errors.New("Please specify a stream name as query param stream")
		}
		return streamID, nil
    })
    r := http.NewServeMux()
    // use handler generated by MakeHandler as http handler on the events endpoint
	r.HandleFunc("/", handler)
```

Publish events to the stream by topic

```golang
    s.Publish("foo", &Event{Data: "test data"})
```

## Full example
```golang
package main

import (
	"fmt"
	sse "golang-sse"
	"log"
	"net/http"
	"time"
)

func postEvents(topic string, s *sse.Server) {
	go func() {
		for {
			time.Sleep(time.Second * 2)
			eventString := fmt.Sprintf("the time is %v", time.Now())
			s.Publish(topic, &sse.Event{Data: eventString})
		}
	}()
}

func main() {
	sseServer := sse.NewServer()

	handler := sseServer.MakeHandler(
		func(r *http.Request) (string, error) {
			// only one topic, always "test"
			return "test", nil
		},
	)
	// Create a new Mux and set the handler
	mux := http.NewServeMux()
	mux.HandleFunc("/", handler)

	postEvents("test", sseServer)
	log.Fatal("HTTP server error: ", http.ListenAndServe("localhost:3000", mux))
}
```

Then curl `http://localhost:3000`
```bash
$ curl http://localhost:3000/
data: the time is 2019-03-03 09:17:05.725023 -0600 CST m=+6.009243476

data: the time is 2019-03-03 09:17:07.729283 -0600 CST m=+8.013505741

data: the time is 2019-03-03 09:17:09.730229 -0600 CST m=+10.014452410

data: the time is 2019-03-03 09:17:11.730939 -0600 CST m=+12.015164635
```